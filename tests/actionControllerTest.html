<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Action Controller Object Test Page</title>
  <link rel="stylesheet" href="../css/qunit.css">
</head>
<body>
  <div id="qunit"> </div>
  <script src="../src/libs/qunit.js"></script>
  <script src="../src/Model/interfaceResource.js"></script>
  <script src="../src/Model/sketch.js"></script>
  <script src="../src/Libs/utils.js"></script>
  <script src="../src/Action/basicCommands.js"></script>
  <script src="../src/Action/actionController.js"></script>
  <script src="../src/Editor/mediatorObject.js"></script>
  <script src="../src/Editor/globalMediators.js"></script>
  
  <script>
  	/*module("Action Controller Basic test");
  	test
  	( 
  		"Action Controller manipulation", function()
  		{
  			var actionController = new ActionController();
  			//TODO:
  			ok( actionController.generateUndoCommmand(null) == false, "TODO");
  		}
  	);
  	*/
  	module("Command undo with only one command type");
  	test
  	( 
  		"Drag Command", function()
  		{
  			var i = 0;
  			var n = 10;
  			var x = 30;
			var y = 10;
			var btn1 = new InterfaceResource( x,y,0,100, 50, "Button", 0, 0 );
  			var actionController = new ActionController();
  			var dragCommand = new DragResourceCommand( basicCommandsGlobals.executionTypeEnum.CMEX_EDITION, btn1, x+x, y+y );
  			ok( actionController.undo() == null , "Nothing to be undone");
  			ok( actionController.redo() == null , "Nothing to be redone");
  			
  			//TODO:
  			ok( btn1.getX() == x, "In the start the button's X position is " + btn1.getX() );
  			ok( actionController.doCommand(dragCommand) == true, "Dragging this object");
  			ok( btn1.getX() == x+x, "After this the button's X position is " + btn1.getX() );
  			ok( actionController.undo() != null , "Undo the last action");
  			ok( btn1.getX() == x, "And the button is  back to the start X position " + btn1.getX() );
  			ok( actionController.redo() != null , "Redo the undone action");
  			ok( btn1.getX() == x+x, "After the redo the button's X position is " + btn1.getX() );
  			ok( actionController.undo() != null , "Undo the redo action");
  			ok( btn1.getX() == x, "And the button is  back to the start X position " + btn1.getX() + " again" );
  			
  			// Moving the object with n commands, at the end it will be on (x+n*n,y+n*n) position in units
  			for( i = 1; i <= n; i ++ )
  			{
  				dragCommand = new DragResourceCommand( basicCommandsGlobals.executionTypeEnum.CMEX_EDITION, btn1, x+i*n, y+i*n );
  				actionController.doCommand(dragCommand);
  			}
  			ok( btn1.getX() == x+n*n, "After moving "+n+" times the button's X position is " + (x+n*n) );
  			ok( actionController.undo() != null , "Undo the last action");
  			ok( btn1.getX() == x+n*(n-1), "After undo 1 times the button's X position is " + (x+n*(n-1)) );
  			for( i = 0; i < n-1; i ++ )
  			{
				if( actionController.undo() == null )
					break;
  			}
  			ok( i == n-1, "All the "+(n-1)+" commands have been undone");
  			ok( btn1.getX() == x, "And the button is  back to the start X position " + x );
  			ok( actionController.redo() != null , "Redo the undone action");
  			ok( actionController.redo() != null , "Redo the undone action again");
  			ok( btn1.getX() == x+2*n, "After the redo the button's X position is " + (x+2*n) );
  			ok( actionController.undo() != null , "Undo the redo action");
  			ok( actionController.undo() != null , "Undo the redo action again");
  			ok( btn1.getX() == x, "After this button is  back to the start X position " + btn1.getX() + " again" );
  			ok( actionController.undo() == null , "There are no more commands to be undone");
  		}
  	);
  	
  	module("Rename Resource Test");
  	test
  	( 
  		"Rename Command", function()
  		{
  			var newName = "pewpew";
  			var oldName = "old";
  			var n = 10;
  			var x = 30;
			var y = 10;
			
			globalMediators.start();
			
			var btn1 = new InterfaceResource( x,y,0,100, 50, oldName, 0, 0 );
  			var actionController = new ActionController();
  			var renameCommand =  new RenameResourceCommand( basicCommandsGlobals.executionTypeEnum.CMEX_EDITION, 
  				btn1, newName );
  			ok( actionController.undo() == null , "Nothing to be undone");
  			ok( actionController.redo() == null , "Nothing to be redone");
  			ok( btn1.getName() == oldName, "The resource is with the old name");
  			ok( actionController.doCommand(renameCommand) == true, "Renaming this object");
  			ok( btn1.getName() == newName, "Now the resource is with the new name");
  			ok( actionController.undo() != null , "Undo the last action");
  			ok( btn1.getName() == oldName, "The resource is with the old name again");
  			ok( actionController.redo() != null , "Redo the last action");
  			ok( btn1.getName() == newName, "Now the resource is with the new name again");
  			ok( actionController.redo() == null , "There are no more commands to be redone");
  		}
  	);
  	
  	module("Resource Creation Test");
  	test(
  		"Simple Creation test", function()
  		{
			var sketchName = "test";
			var sketchAuthor = "tester";
			var sketchObj = new Sketch( sketchName, sketchAuthor );
			var currentScreen = sketchObj.getCurrentScreen();
			
			globalMediators.start();
			var actionController = new ActionController();
			
			var version = 0;
			var createCommand = new CreateResourceCommand( 
				basicCommandsGlobals.executionTypeEnum.CMEX_EDITION, 
				resourceTypeEnum.IR_BUTTON, sketchObj );
				

			ok( currentScreen.getResources().length == 0, "There are no elements on the current screen");	
			ok( actionController.undo() == null , "Nothing to be undone");
  			ok( actionController.redo() == null , "Nothing to be redone");
  			
  			ok( actionController.doCommand( createCommand ) == true, "Creating a button");
  			
  			ok( currentScreen.getResources().length == 1, "Now there are one element on the current screen");	
  			var newButtonResHistory = currentScreen.getResources()[0]; 
  			ok( newButtonResHistory.getHistoryLength() == 1, 
  				"Every new element start with only one version");
  			ok( newButtonResHistory.getId() == 0, "The first new resource has the id 0");
  			
  			ok( actionController.undo() != null , "Undo the button creation action");
  			ok( currentScreen.getResources().length == 0, "Now there are zero elements on the current screen");	
  			
  			ok( actionController.redo() != null , "Redo the button creation action");
  			ok( currentScreen.getResources().length == 1, "Now there are one element on the current screen again");	
  			newButtonResHistory = currentScreen.getResources()[0]; 
  			ok( newButtonResHistory.getHistoryLength() == 1, 
  				"This new element start with only one version");
  			ok( newButtonResHistory.getId() == 0, "The first new resource still with the id 0");
  			
  			ok( actionController.undo() != null , "Undo the button creation action");
  			ok( currentScreen.getResources().length == 0, "Finally there are zero elements on the current screen");	
  		}
  	);
  	
 	test(
  		"Multiple Simple Creation test", function()
  		{
			var sketchName = "test";
			var sketchAuthor = "tester";
			var sketchObj = new Sketch( sketchName, sketchAuthor );
			var currentScreen = sketchObj.getCurrentScreen();
			
			var buttonNum = 10;
			
			globalMediators.start();
			var actionController = new ActionController();
			
			var version = 0;
			var commands = [];
			var allButtonsProccessed = true;
			var i = 0;
			
			ok( currentScreen.getResources().length == 0, "There are no elements on the current screen");	
			ok( actionController.undo() == null , "Nothing to be undone");
  			ok( actionController.redo() == null , "Nothing to be redone");
			
			for( i = 0; i < buttonNum; i++ )
			{
				commands[i] = new CreateResourceCommand( 
					basicCommandsGlobals.executionTypeEnum.CMEX_EDITION, 
					resourceTypeEnum.IR_BUTTON, sketchObj );
				allButtonsProccessed = allButtonsProccessed && ( actionController.doCommand( commands[i]  ) == true );
			}	

  			ok( allButtonsProccessed  == true, "Creating " + buttonNum + " buttons");
  			

  			
  			ok( currentScreen.getResources().length == buttonNum, 
  				"Now there are " + buttonNum + " buttons on the current screen");	
  			//console.log( JSON.stringify( sketchObj ) );
  			
  			var newButtonResHistory = currentScreen.getResources()[ buttonNum - 1 ]; 
  			ok( newButtonResHistory.getHistoryLength() == 1, 
  				"Every new element start with only one version");
  			ok( newButtonResHistory.getId() == buttonNum - 1 , 
  				"The new resource created for last has the id " + ( buttonNum - 1 ) );

			for( i = 0; i < buttonNum; i++ )
			{
				allButtonsProccessed = allButtonsProccessed && ( actionController.undo()  != true );
			}	
			ok( allButtonsProccessed  == true, "All commands undone");
			ok( actionController.undo() == null , "Nothing to be undone");
			
			for( i = 0; i < buttonNum/2; i++ )
			{
				allButtonsProccessed = allButtonsProccessed && ( actionController.redo()  != true );
			}	
			ok( allButtonsProccessed  == true, "Half of the commands redone");
			newButtonResHistory = currentScreen.getResources()[ (buttonNum/2) - 1 ]; 
  			ok( newButtonResHistory.getHistoryLength() == 1, 
  				"Every new element start with only one version");
  			ok( newButtonResHistory.getId() == ((buttonNum/2)  - 1) , 
  				"The new resource created by the last redo has the id " + ( (buttonNum/2)  - 1 ) );
  		}
  	);
  	
  	test(
  		"Explicit Deletion test", function()
  		{
			var sketchName = "test";
			var sketchAuthor = "tester";
			var sketchObj = new Sketch( sketchName, sketchAuthor );
			var currentScreen = sketchObj.getCurrentScreen();
			
			globalMediators.start();
			var actionController = new ActionController();
			
			var version = 0;
			var createCommand = new CreateResourceCommand( 
				basicCommandsGlobals.executionTypeEnum.CMEX_EDITION, 
				resourceTypeEnum.IR_BUTTON, sketchObj );
				

			ok( currentScreen.getResources().length == 0, "There are no elements on the current screen");	
			ok( actionController.undo() == null , "Nothing to be undone");
  			ok( actionController.redo() == null , "Nothing to be redone");
  			
  			ok( actionController.doCommand( createCommand ) == true, "Creating a button");
  			
  			ok( currentScreen.getResources().length == 1, "Now there are one element on the current screen");	
  			
  			var newButtonResHistory = currentScreen.getResources()[ 0 ]; 
  			
  			var deleteCommand =  new DeleteResourceCommand( 
				basicCommandsGlobals.executionTypeEnum.CMEX_EDITION, 
				newButtonResHistory.getId(), sketchObj );
			
			ok( actionController.doCommand( deleteCommand ) == true, "Deleting the new button");
  			
  			ok( currentScreen.getResources().length == 0, "Now there are zero elements on the current screen");	
  			
  			ok( actionController.undo() != null , "Undo the button creation action");
  			ok( currentScreen.getResources().length == 1, "Now there are one element on the current screen again");	
  			
  			ok( actionController.redo() != null , "Redo the button creation action");
  			ok( currentScreen.getResources().length == 0, "Now there are zero elements on the current screen again");	
				
  		}
  	);
  	
  </script>
</body>
</html>